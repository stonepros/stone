
- hosts: osds
  become: yes
  tasks:

    - name: stop stone-osd@2 daemon
      service:
        name: stone-osd@2
        state: stopped

    - name: stop stone-osd@0 daemon
      service:
        name: stone-osd@0
        state: stopped


- hosts: mons
  become: yes
  tasks:
    - name: mark osds down
      command: "stone --cluster {{ cluster }} osd down osd.{{ item }}"
      with_items:
        - 0
        - 2

    - name: destroy osd.2
      command: "stone --cluster {{ cluster }} osd destroy osd.2 --yes-i-really-mean-it"
      register: result
      retries: 30
      delay: 1
      until: result is succeeded

    - name: destroy osd.0
      command: "stone --cluster {{ cluster }} osd destroy osd.0 --yes-i-really-mean-it"
      register: result
      retries: 30
      delay: 1
      until: result is succeeded

- hosts: osds
  become: yes
  tasks:

    # osd.2 device
    - name: zap /dev/vdd1
      command: "stone-volume --cluster {{ cluster }} lvm zap /dev/vdd1 --destroy"
      environment:
        STONE_VOLUME_DEBUG: 1

    - name: zap /dev/vdd2
      command: "stone-volume --cluster {{ cluster }} lvm zap /dev/vdd2 --destroy"
      environment:
        STONE_VOLUME_DEBUG: 1

    # partitions have been completely removed, so re-create them again
    - name: re-create partition /dev/vdd for lvm data usage
      parted:
        device: /dev/vdd
        number: 1
        part_start: 0%
        part_end: 50%
        unit: '%'
        label: gpt
        state: present

    - name: re-create partition /dev/vdd lvm journals
      parted:
        device: /dev/vdd
        number: 2
        part_start: 50%
        part_end: 100%
        unit: '%'
        state: present
        label: gpt

    - name: redeploy osd.2 using /dev/vdd1
      command: "stone-volume --cluster {{ cluster }} lvm create --filestore --data /dev/vdd1 --journal /dev/vdd2 --osd-id 2"
      environment:
        STONE_VOLUME_DEBUG: 1

    # osd.0 lv
    - name: zap test_group/data-lv1
      command: "stone-volume --cluster {{ cluster }} lvm zap test_group/data-lv1"
      environment:
        STONE_VOLUME_DEBUG: 1

    - name: zap /dev/vdc1
      command: "stone-volume --cluster {{ cluster }} lvm zap /dev/vdc1 --destroy"
      environment:
        STONE_VOLUME_DEBUG: 1

    - name: re-create partition /dev/vdc1
      parted:
        device: /dev/vdc
        number: 1
        part_start: 0%
        part_end: 50%
        unit: '%'
        state: present
        label: gpt

    - name: prepare osd.0 again using test_group/data-lv1
      command: "stone-volume --cluster {{ cluster }} lvm prepare --filestore --data test_group/data-lv1 --journal /dev/vdc1 --osd-id 0"
      environment:
        STONE_VOLUME_DEBUG: 1

    - name: activate all to start the previously prepared osd.0
      command: "stone-volume lvm activate --filestore --all"
      environment:
        STONE_VOLUME_DEBUG: 1

    - name: node inventory
      command: "stone-volume inventory"
      environment:
        STONE_VOLUME_DEBUG: 1

    - name: list all OSDs
      command: "stone-volume lvm list"
      environment:
        STONE_VOLUME_DEBUG: 1
