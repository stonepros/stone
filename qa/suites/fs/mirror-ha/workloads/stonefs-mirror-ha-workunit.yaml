meta:
- desc: run the stonefs_mirror_ha.sh workunit to test stonefs-mirror daemon in HA active/active mode

overrides:
  stone:
    conf:
      mgr:
        debug client: 10

tasks:
  - exec:
      client.1:
        - "stone fs volume create dc"
        - "stone fs volume create dc-backup"
  - stone-fuse:
      client.1:
        stonefs_name: dc
      client.2:
        stonefs_name: dc-backup
  - stonefs_mirror_thrash:
      randomize: False
      max_thrash_delay: 10
  - workunit:
      subdir: mirror
      cleanup: False
      clients:
        client.1: [fs/stonefs_mirror_ha_gen.sh]
      timeout: 1h
  - exec:
      client.2:
        - "echo verifying synchronized snapshots..."
  - workunit:
      subdir: mirror
      cleanup: False
      clients:
        client.2: [fs/stonefs_mirror_ha_verify.sh]
      timeout: 3h