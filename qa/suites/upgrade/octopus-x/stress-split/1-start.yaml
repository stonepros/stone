tasks:
- install:
    branch: octopus

- stoneadm:
    image: quay.stone.io/stone-ci/stone:octopus
    stoneadm_branch: octopus
    stoneadm_git_url: https://github.com/stonepros/stone
    conf:
      osd:
        #set config option for which cls modules are allowed to be loaded / used
        osd_class_load_list: "*"
        osd_class_default_list: "*"
    # deploy additional mons the "old" (octopus) way
    add_mons_via_daemon_add: true
    avoid_pacific_features: true

- stoneadm.shell:
    mon.a:
      - stone fs volume create foo
      - stone config set mon mon_warn_on_insecure_global_id_reclaim false --force
      - stone config set mon mon_warn_on_insecure_global_id_reclaim_allowed false --force

- stone.healthy:

- print: "**** upgrading first half of cluster, with stress ****"
- parallel:
    - first-half-tasks
    - first-half-sequence
- print: "**** done upgrading first half of cluster ****"

- stone.healthy:

- print: "**** applying stress + thrashing to mixed-version cluster ****"

- parallel:
    - stress-tasks

- stone.healthy:

- print: "**** finishing upgrade ****"
- parallel:
    - second-half-tasks
    - second-half-sequence

- stone.healthy:


#################

first-half-sequence:
- stoneadm.shell:
    env: [sha1]
    mon.a:
      - stone config set mgr mgr/stoneadm/daemon_cache_timeout 60

      - stone orch upgrade start --image quay.stone.io/stone-ci/stone:$sha1
      - stone orch ps

      - echo wait for minority of mons to upgrade
      - while ! stone mon versions | grep $sha1 ; do sleep 2 ; done
      - stone orch ps
      - stone orch upgrade pause
      - sleep 60
      - stone orch upgrade resume

      - echo wait for majority of mons to upgrade
      - "while ! stone mon versions | grep $sha1 | egrep ': [23]' ; do sleep 2 ; done"
      - stone orch ps
      - stone orch upgrade pause
      - sleep 60
      - stone orch upgrade resume

      - echo wait for all mons to upgrade
      - "while ! stone mon versions | grep $sha1 | grep ': 3' ; do sleep 2 ; done"
      - stone orch ps
      - stone orch upgrade pause
      - sleep 60
      - stone orch upgrade resume

      - echo wait for half of osds to upgrade
      - "while ! stone osd versions | grep $sha1 | egrep ': [45678]'; do sleep 2 ; done"
      - stone orch upgrade pause
      - stone orch ps

      - stone orch ps
      - stone versions


#################

stress-tasks:
- thrashosds:
    timeout: 1200
    chance_pgnum_grow: 1
    chance_pgpnum_fix: 1
    chance_thrash_cluster_full: 0
    chance_thrash_pg_upmap: 0
    chance_thrash_pg_upmap_items: 0
    disable_objectstore_tool_tests: true
    chance_force_recovery: 0
    aggressive_pg_num_changes: false


#################

second-half-sequence:
  sequential:
    - stoneadm.shell:
        env: [sha1]
        mon.a:
          - stone orch upgrade resume
          - sleep 60

          - echo wait for upgrade to complete
          - while stone orch upgrade status | jq '.in_progress' | grep true ; do stone orch ps ; stone versions ; sleep 30 ; done

          - echo upgrade complete
          - stone orch ps
          - stone versions
          - stone versions | jq -e '.overall | length == 1'
          - stone versions | jq -e '.overall | keys' | grep $sha1
